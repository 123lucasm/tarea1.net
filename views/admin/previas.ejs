<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Previas - MATRICULATEC</title>
    
    <!-- Tailwind CSS Local -->
    <link rel="stylesheet" href="/css/tailwind.css">
    <!-- Admin CSS Personalizado -->
    <link rel="stylesheet" href="/css/admin.css">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-utec-light font-inter">
    <!-- Navigation -->
    <nav class="admin-nav">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="nav-brand">
                    <div class="brand-icon">
                        <i class="fas fa-shield-alt text-white text-2xl"></i>
                    </div>
                    <div class="brand-text">
                        <h1>Panel Admin</h1>
                        <p>MATRICULATEC</p>
                    </div>
                </div>
                <div class="nav-user">
                    <div class="user-info">
                        <p class="user-name"><%= usuario.nombre %> <%= usuario.apellido %></p>
                        <p class="user-role">Administrador</p>
                    </div>
                    <div class="nav-actions">
                        <div class="connection-status" id="connection-status">
                            <div class="status-indicator" id="status-indicator"></div>
                            <span id="status-text">Conectando...</span>
                        </div>
                        <a href="/admin">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                        <a href="/admin/usuarios">
                            <i class="fas fa-users"></i>
                            <span>Usuarios</span>
                        </a>
                        <a href="/admin/materias">
                            <i class="fas fa-book"></i>
                            <span>Materias</span>
                        </a>
                        <a href="/auth/logout">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Salir</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header Section -->
        <div class="mb-8">
            <div class="welcome-section">
                <div class="welcome-content">
                    <h1 class="welcome-title">
                        <i class="fas fa-link mr-4"></i>
                        Gesti√≥n de Previas
                    </h1>
                    <p class="welcome-subtitle">
                        Administra los requisitos acad√©micos y prerrequisitos de las materias
                    </p>
                    <div class="welcome-info">
                        <div class="welcome-info-item">
                            <i class="fas fa-link"></i>
                            <span id="total-previas">0 materias con previas</span>
                        </div>


                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Total Materias con Previas -->
            <div class="stat-card amber">
                <div class="flex items-center justify-between mb-4">
                    <div class="stat-icon amber">
                        <i class="fas fa-link text-white text-xl"></i>
                    </div>
                    <div class="text-right">
                        <p class="stat-number" id="total-previas-count">0</p>
                        <p class="stat-label">materias</p>
                    </div>
                </div>
                <h3 class="stat-title">Materias con Previas</h3>
                <p class="stat-description">Total de materias que requieren previas</p>
            </div>

            <!-- Materias con Previas Activas -->
            <div class="stat-card emerald">
                <div class="flex items-center justify-between mb-4">
                    <div class="stat-icon emerald">
                        <i class="fas fa-check-circle text-white text-xl"></i>
                    </div>
                    <div class="text-right">
                        <p class="stat-number" id="previas-activas-count">0</p>
                        <p class="stat-label">activas</p>
                    </div>
                </div>
                <h3 class="stat-title">Materias Activas</h3>
                <p class="stat-description">Materias con previas vigentes</p>
            </div>

            <!-- Previas por Curso -->
            <div class="stat-card indigo">
                <div class="flex items-center justify-between mb-4">
                    <div class="stat-icon indigo">
                        <i class="fas fa-graduation-cap text-white text-xl"></i>
                    </div>
                    <div class="text-right">
                        <p class="stat-number" id="previas-curso-count">0</p>
                        <p class="stat-label">requisitos</p>
                    </div>
                </div>
                <h3 class="stat-title">Requisitos por Curso</h3>
                <p class="stat-description">Total de previas tipo curso</p>
            </div>

            <!-- Previas por Examen -->
            <div class="stat-card violet">
                <div class="flex items-center justify-between mb-4">
                    <div class="stat-icon violet">
                        <i class="fas fa-file-alt text-white text-xl"></i>
                    </div>
                    <div class="text-right">
                        <p class="stat-number" id="previas-examen-count">0</p>
                        <p class="stat-label">requisitos</p>
                    </div>
                </div>
                <h3 class="stat-title">Requisitos por Examen</h3>
                <p class="stat-description">Total de previas tipo examen</p>
            </div>
        </div>

        <!-- Filters and Search -->
            <div class="card-utec mb-8">
                <div class="flex flex-col lg:flex-row gap-4 items-center justify-between">
                    <div class="flex flex-col sm:flex-row gap-4 flex-1">
                        <!-- Search -->
                        <div class="relative flex-1">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-slate-400"></i>
                            </div>
                            <input type="text" id="search-previas" placeholder="Buscar por materia, c√≥digo o previa requerida..." 
                                   class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        
                        <!-- Filter by Type -->
                        <select id="filter-tipo" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="">Todos los tipos</option>
                            <option value="curso_aprobado">Curso Aprobado</option>
                            <option value="examen_aprobado">Examen Aprobado</option>
                        </select>
                        
                        <!-- Filter by Status -->
                        <select id="filter-estado" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="">Todos los estados</option>
                            <option value="true">Solo activas</option>
                            <option value="false">Solo inactivas</option>
                        </select>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex gap-3">
                        <button id="limpiar-filtros" class="btn-secondary">
                            <i class="fas fa-times"></i>
                            Limpiar
                        </button>
                        <button id="aplicar-filtros" class="btn-secondary">
                            <i class="fas fa-filter"></i>
                            Aplicar
                        </button>
                        <button class="btn-nueva-previa btn-success">
                            <i class="fas fa-plus mr-2"></i>
                            Nueva Previa
                        </button>
                    </div>
                </div>
            </div>

        <!-- Previas Table -->
        <div class="card-utec">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200 previas-table">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                <div class="flex items-center">
                                    <i class="fas fa-book mr-2"></i>
                                    <span>Materia</span>
                                </div>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                <div class="flex items-center">
                                    <i class="fas fa-link mr-2"></i>
                                    <span>Previas Requeridas</span>
                                </div>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                <div class="flex items-center">
                                    <i class="fas fa-tag mr-2"></i>
                                    <span>Tipos</span>
                                </div>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                <div class="flex items-center">
                                    <i class="fas fa-toggle-on mr-2"></i>
                                    <span>Estado</span>
                                </div>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                <div class="flex items-center">
                                    <i class="fas fa-calendar-alt mr-2"></i>
                                    <span>Semestre</span>
                                </div>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                <div class="flex items-center">
                                    <i class="fas fa-cog mr-2"></i>
                                    <span>Acciones</span>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="previas-tbody" class="bg-white divide-y divide-slate-200">
                        <!-- Loading state -->
                        <tr id="loading-row">
                            <td colspan="6" class="px-6 py-12 text-center">
                                <div class="flex flex-col items-center">
                                    <i class="fas fa-spinner fa-spin text-4xl text-slate-400 mb-4"></i>
                                    <p class="text-slate-500">Cargando previas...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Controls -->
            <div id="pagination-container" class="px-6 py-4 border-t border-slate-200 bg-slate-50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center text-sm text-slate-700">
                        <span id="pagination-info">Mostrando 0 de 0 previas</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="prev-page" class="px-3 py-1 text-sm bg-white border border-slate-300 rounded-md hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed btn-pagina-prev">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        
                        <div id="page-numbers" class="flex space-x-1">
                            <!-- Page numbers will be generated here -->
                        </div>
                        
                        <button id="next-page" class="px-3 py-1 text-sm bg-white border border-slate-300 rounded-md hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed btn-pagina-next">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    <!-- Modal Crear/Editar Previa -->
    <div id="modal-previa" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Nueva Previa</h3>
                <button class="modal-close btn-cerrar-modal-previa">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="form-previa" class="modal-body">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Materia</label>
                        <select id="materia" name="materia" class="form-select" required>
                            <option value="">Seleccionar materia</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Materia Requerida</label>
                        <select id="materiaRequerida" name="materiaRequerida" class="form-select" required>
                            <option value="">Seleccionar materia requerida</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Tipo de Requisito</label>
                        <select id="tipo" name="tipo" class="form-select" required>
                            <option value="curso_aprobado">Curso Aprobado</option>
                            <option value="examen_aprobado">Examen Aprobado</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Nota M√≠nima</label>
                        <select id="notaMinima" name="notaMinima" class="form-select" required>
                            <option value="1">1 - Deficiente</option>
                            <option value="2">2 - Insuficiente</option>
                            <option value="3" selected>3 - Suficiente</option>
                            <option value="4">4 - Muy Bueno</option>
                            <option value="5">5 - Excelente</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Semestre M√≠nimo</label>
                        <input type="number" id="semestreMinimo" name="semestreMinimo" 
                               class="form-input" min="1" max="20" placeholder="Opcional">
                    </div>
                    <div>
                        <label class="form-label">Cr√©ditos M√≠nimos</label>
                        <input type="number" id="creditosMinimos" name="creditosMinimos" 
                               class="form-input" min="0" placeholder="Opcional">
                    </div>
                </div>
                <div class="flex items-center space-x-2 mt-4">
                    <input type="checkbox" id="activa" name="activa" class="form-checkbox" checked>
                    <label for="activa" class="form-label-checkbox">Previa activa</label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary btn-cerrar-modal-previa">
                        Cancelar
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save mr-2"></i>
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para ver previas detalladas -->
    <div id="modal-previas-detalle" class="modal hidden">
        <div class="modal-content max-w-4xl">
            <div class="modal-header">
                <h3 class="text-lg font-semibold text-slate-900" id="modal-previas-titulo">
                    Previas Requeridas
                </h3>
                <button class="modal-close btn-cerrar-modal-detalle">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="previas-detalle-content" class="space-y-4">
                    <!-- El contenido se generar√° din√°micamente -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary btn-cerrar-modal-detalle">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        let previas = [];
        let materias = [];
        let paginaActual = 1;
        let previasPorPagina = 10;
        let previasFiltradas = [];
        let handleEscape = null; // Variable global para el evento de teclado

        // Inicializar Socket.IO
        const socket = io();
        
        document.addEventListener('DOMContentLoaded', function() {
            cargarPrevias();
            cargarMaterias();
            configurarSocketEvents();
            configurarEventosModales();
            configurarEventosBotones();
        });
        
        function configurarSocketEvents() {
            socket.on('nueva-previa', function(data) {
                mostrarNotificacion('Nueva previa creada', `${data.materia.nombre} requiere ${data.previa.nombre}`);
                cargarPrevias();
            });
            
            socket.on('connect', function() {
                actualizarEstadoConexion('connected', 'Conectado');
            });
            
            socket.on('disconnect', function() {
                actualizarEstadoConexion('disconnected', 'Desconectado');
            });
        }

        function configurarEventosModales() {
            // Cerrar modal de previas detalladas al hacer clic fuera
            document.getElementById('modal-previas-detalle').addEventListener('click', function(e) {
                if (e.target === this) {
                    cerrarModalPreviasDetalle();
                }
            });
            
            // Cerrar modal de previa al hacer clic fuera
            document.getElementById('modal-previa').addEventListener('click', function(e) {
                if (e.target === this) {
                    cerrarModalPrevia();
                }
            });
        }

        function configurarEventosBotones() {
            // Delegaci√≥n de eventos para los botones de la tabla
            document.addEventListener('click', function(e) {
                const target = e.target;
                
                // Bot√≥n Ver previas detalladas
                if (target.closest('.btn-ver-previas')) {
                    const button = target.closest('.btn-ver-previas');
                    const materiaId = button.getAttribute('data-materia-id');
                    verPreviasDetalle(materiaId);
                }
                
                // Bot√≥n Editar previa
                if (target.closest('.btn-editar-previa')) {
                    const button = target.closest('.btn-editar-previa');
                    const materiaId = button.getAttribute('data-materia-id');
                    editarPrevia(materiaId);
                }
                
                // Bot√≥n Toggle previa
                if (target.closest('.btn-toggle-previa')) {
                    const button = target.closest('.btn-toggle-previa');
                    const materiaId = button.getAttribute('data-materia-id');
                    const estadoActual = button.getAttribute('data-estado') === 'true';
                    togglePrevia(materiaId, estadoActual);
                }
                
                // Bot√≥n Eliminar previa
                if (target.closest('.btn-eliminar-previa')) {
                    const button = target.closest('.btn-eliminar-previa');
                    const materiaId = button.getAttribute('data-materia-id');
                    eliminarPrevia(materiaId);
                }
                
                // Bot√≥n Nueva Previa
                if (target.closest('.btn-nueva-previa')) {
                    abrirModalPrevia();
                }
                
                // Botones de cerrar modal de previas detalladas
                if (target.closest('.btn-cerrar-modal-detalle')) {
                    cerrarModalPreviasDetalle();
                }
                
                // Botones de cerrar modal de previa
                if (target.closest('.btn-cerrar-modal-previa')) {
                    cerrarModalPrevia();
                }
            });
            
            // Event listeners para filtros
            document.getElementById('search-previas').addEventListener('input', filtrarPrevias);
            document.getElementById('filter-tipo').addEventListener('change', filtrarPrevias);
            document.getElementById('filter-estado').addEventListener('change', filtrarPrevias);
            document.getElementById('limpiar-filtros').addEventListener('click', limpiarFiltros);
            document.getElementById('aplicar-filtros').addEventListener('click', aplicarFiltros);
            
            // Event listeners para paginaci√≥n
            document.getElementById('prev-page').addEventListener('click', () => cambiarPagina(-1));
            document.getElementById('next-page').addEventListener('click', () => cambiarPagina(1));
            
            // Delegaci√≥n de eventos para n√∫meros de p√°gina
            document.addEventListener('click', function(e) {
                if (e.target.closest('.btn-pagina-numero')) {
                    const pagina = parseInt(e.target.getAttribute('data-pagina'));
                    irAPagina(pagina);
                }
            });
        }
        
        function actualizarEstadoConexion(estado, texto) {
            const indicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            
            if (indicator && statusText) {
                indicator.className = `status-indicator ${estado}`;
                statusText.textContent = texto;
            }
        }

        async function cargarPrevias() {
            console.log('üîÑ Cargando previas...');
            try {
                const response = await fetch('/admin/api/previas', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üì¶ Datos recibidos de la API:', data);
                console.log('üîç Primera previa completa:', data[0]);
                
                if (data[0] && data[0].materia) {
                    console.log('üè´ Materia de la primera previa:', data[0].materia);
                    console.log('üìÖ Semestre de la materia:', data[0].materia.semestre);
                    console.log('üìÖ Tipo de semestre:', typeof data[0].materia.semestre);
                    
                    if (data[0].materia.semestre && typeof data[0].materia.semestre === 'object') {
                        console.log('üìÖ Nombre del semestre:', data[0].materia.semestre.nombre);
                        console.log('üìÖ N√∫mero del semestre:', data[0].materia.semestre.numero);
                        console.log('üìÖ Semestre completo:', data[0].materia.semestre);
                        console.log('üìÖ Keys del semestre:', Object.keys(data[0].materia.semestre));
                    } else {
                        console.log('‚ùå El semestre NO es un objeto:', data[0].materia.semestre);
                        console.log('‚ùå Tipo del semestre:', typeof data[0].materia.semestre);
                    }
                }
                
                previas = data;
                previasFiltradas = [...previas];
                
                actualizarEstadisticas();
                mostrarPrevias();
                
            } catch (error) {
                console.error('‚ùå Error cargando previas:', error);
                mostrarError('Error cargando previas: ' + error.message);
            }
        }

        async function cargarMaterias() {
            try {
                const response = await fetch('/admin/api/materias', {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status}`);
                }
                
                const data = await response.json();
                materias = data.materias || data;
                
                // Llenar selectores del modal
                llenarSelectoresMaterias();
                
            } catch (error) {
                console.error('Error cargando materias:', error);
            }
        }

        function llenarSelectoresMaterias() {
            const selectMateria = document.getElementById('materia');
            const selectMateriaRequerida = document.getElementById('materiaRequerida');
            
            // Limpiar opciones existentes
            selectMateria.innerHTML = '<option value="">Seleccionar materia</option>';
            selectMateriaRequerida.innerHTML = '<option value="">Seleccionar materia requerida</option>';
            
            materias.forEach(materia => {
                const option1 = document.createElement('option');
                option1.value = materia._id;
                option1.textContent = `${materia.codigo} - ${materia.nombre}`;
                
                const option2 = document.createElement('option');
                option2.value = materia._id;
                option2.textContent = `${materia.codigo} - ${materia.nombre}`;
                
                selectMateria.appendChild(option1);
                selectMateriaRequerida.appendChild(option2);
            });
        }

        function actualizarEstadisticas() {
            const total = previas.length;
            const activas = previas.filter(p => p.activa).length;
            const porCurso = previas.filter(p => p.tipo === 'curso_aprobado').length;
            const porExamen = previas.filter(p => p.tipo === 'examen_aprobado').length;
            
            // Calcular estad√≠sticas de materias √∫nicas
            const materiasUnicas = agruparPreviasPorMateria(previas);
            const materiasConPrevias = materiasUnicas.length;
            
            document.getElementById('total-previas-count').textContent = materiasConPrevias;
            document.getElementById('previas-activas-count').textContent = materiasUnicas.filter(g => g.activa).length;
            document.getElementById('previas-curso-count').textContent = porCurso;
            document.getElementById('previas-examen-count').textContent = porExamen;
            document.getElementById('total-previas').textContent = `${materiasConPrevias} materias con previas`;
        }

        function mostrarPrevias() {
            const tbody = document.getElementById('previas-tbody');
            
            if (previasFiltradas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-inbox text-4xl text-slate-400 mb-4"></i>
                                <p class="text-slate-500">No se encontraron previas</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Agrupar previas por materia
            const previasAgrupadas = agruparPreviasPorMateria(previasFiltradas);
            
            const inicio = (paginaActual - 1) * previasPorPagina;
            const fin = inicio + previasPorPagina;
            const previasPagina = previasAgrupadas.slice(inicio, fin);
            
            tbody.innerHTML = previasPagina.map(grupo => `
                <tr class="hover:bg-slate-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-2 h-2 bg-emerald-500 rounded-full mr-3"></div>
                            <div>
                                <div class="text-sm font-medium text-slate-900">${grupo.materia?.nombre || 'N/A'}</div>
                                <div class="text-sm text-slate-500">${grupo.materia?.codigo || 'N/A'}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-slate-600">${grupo.totalPrevias} previa${grupo.totalPrevias !== 1 ? 's' : ''}</span>
                            <button class="btn-icon btn-icon-primary btn-ver-previas" 
                                    data-materia-id="${grupo.materia._id}"
                                    data-previas='${JSON.stringify(grupo.previas)}'
                                    title="Ver previas detalladas">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="space-y-1">
                            ${Array.from(grupo.tipos).map(tipo => `
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                                    tipo === 'curso_aprobado' 
                                        ? 'bg-emerald-100 text-emerald-800' 
                                        : 'bg-violet-100 text-violet-800'
                                }">
                                    <i class="fas fa-${tipo === 'curso_aprobado' ? 'graduation-cap' : 'file-alt'} mr-1"></i>
                                    ${tipo === 'curso_aprobado' ? 'Curso' : 'Examen'}
                                </span>
                            `).join('')}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                            grupo.activa 
                                ? 'bg-emerald-100 text-emerald-800' 
                                : 'bg-red-100 text-red-800'
                        }">
                            <i class="fas fa-${grupo.activa ? 'check-circle' : 'times-circle'} mr-1"></i>
                            ${grupo.activa ? 'Activa' : 'Inactiva'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-slate-600">${grupo.materia.semestre || 'N/A'}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center space-x-2">
                            <button class="btn-icon btn-icon-primary btn-editar-previa" 
                                    data-materia-id="${grupo.materia._id}" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon ${grupo.activa ? 'btn-icon-warning' : 'btn-icon-success'} btn-toggle-previa" 
                                    data-materia-id="${grupo.materia._id}"
                                    data-estado="${grupo.activa}"
                                    title="${grupo.activa ? 'Desactivar' : 'Activar'}">
                                <i class="fas fa-${grupo.activa ? 'pause' : 'play'}"></i>
                            </button>
                            <button class="btn-icon btn-icon-danger btn-eliminar-previa" 
                                    data-materia-id="${grupo.materia._id}" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            actualizarPaginacion();
        }

        function actualizarPaginacion() {
            const materiasAgrupadas = agruparPreviasPorMateria(previasFiltradas);
            const totalPaginas = Math.ceil(materiasAgrupadas.length / previasPorPagina);
            const paginationContainer = document.getElementById('pagination-container');
            const paginationInfo = document.getElementById('pagination-info');
            const prevButton = document.getElementById('prev-page');
            const nextButton = document.getElementById('next-page');
            const pageNumbers = document.getElementById('page-numbers');
            
            if (totalPaginas <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            paginationContainer.style.display = 'block';
            
            // Calcular rangos para mostrar
            const startItem = (paginaActual - 1) * previasPorPagina + 1;
            const endItem = Math.min(paginaActual * previasPorPagina, materiasAgrupadas.length);
            
            // Actualizar informaci√≥n de paginaci√≥n
            paginationInfo.textContent = `Mostrando ${startItem}-${endItem} de ${materiasAgrupadas.length} materias con previas`;
            
            // Actualizar botones
            prevButton.disabled = paginaActual === 1;
            nextButton.disabled = paginaActual === totalPaginas;
            
            // Generar n√∫meros de p√°gina
            generarNumerosPagina(pageNumbers, paginaActual, totalPaginas);
        }

        function cambiarPagina(direccion) {
            const materiasAgrupadas = agruparPreviasPorMateria(previasFiltradas);
            const totalPaginas = Math.ceil(materiasAgrupadas.length / previasPorPagina);
            const nuevaPagina = paginaActual + direccion;
            
            if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas) {
                paginaActual = nuevaPagina;
                mostrarPrevias();
            }
        }

        function irAPagina(numeroPagina) {
            const materiasAgrupadas = agruparPreviasPorMateria(previasFiltradas);
            const totalPaginas = Math.ceil(materiasAgrupadas.length / previasPorPagina);
            
            if (numeroPagina >= 1 && numeroPagina <= totalPaginas) {
                paginaActual = numeroPagina;
                mostrarPrevias();
            }
        }

        function generarNumerosPagina(container, paginaActual, totalPaginas) {
            container.innerHTML = '';
            
            // Mostrar m√°ximo 5 p√°ginas alrededor de la actual
            let inicio = Math.max(1, paginaActual - 2);
            let fin = Math.min(totalPaginas, paginaActual + 2);
            
            // Ajustar para mostrar siempre 5 p√°ginas si es posible
            if (fin - inicio < 4) {
                if (inicio === 1) {
                    fin = Math.min(totalPaginas, inicio + 4);
                } else {
                    inicio = Math.max(1, fin - 4);
                }
            }
            
            // Agregar primera p√°gina si no est√° incluida
            if (inicio > 1) {
                const firstPage = document.createElement('button');
                firstPage.textContent = '1';
                firstPage.className = 'px-3 py-1 text-sm bg-white border border-slate-300 rounded-md hover:bg-slate-50 btn-pagina-numero';
                firstPage.setAttribute('data-pagina', '1');
                container.appendChild(firstPage);
                
                if (inicio > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'px-2 py-1 text-slate-500';
                    container.appendChild(ellipsis);
                }
            }
            
            // Generar n√∫meros de p√°gina
            for (let i = inicio; i <= fin; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = `px-3 py-1 text-sm border rounded-md btn-pagina-numero ${i === paginaActual ? 'bg-emerald-500 text-white border-emerald-500' : 'bg-white border-slate-300 hover:bg-slate-50'}`;
                pageButton.setAttribute('data-pagina', i.toString());
                container.appendChild(pageButton);
            }
            
            // Agregar √∫ltima p√°gina si no est√° incluida
            if (fin < totalPaginas) {
                if (fin < totalPaginas - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'px-2 py-1 text-slate-500';
                    container.appendChild(ellipsis);
                }
                
                const lastPage = document.createElement('button');
                lastPage.textContent = totalPaginas;
                lastPage.className = 'px-3 py-1 text-sm bg-white border border-slate-300 rounded-md hover:bg-slate-50 btn-pagina-numero';
                lastPage.setAttribute('data-pagina', totalPaginas.toString());
                container.appendChild(lastPage);
            }
        }

        // Funci√≥n para agrupar previas por materia
        function agruparPreviasPorMateria(previas) {
            console.log('üîç Previas recibidas para agrupar:', previas);
            const grupos = {};
            
            previas.forEach(previa => {
                console.log('üìö Procesando previa:', previa);
                console.log('üè´ Materia:', previa.materia);
                console.log('üìÖ Semestre de la materia:', previa.materia?.semestre);
                
                const materiaId = previa.materia._id || previa.materia;
                const materiaNombre = previa.materia.nombre || 'N/A';
                const materiaCodigo = previa.materia.codigo || 'N/A';
                const materiaSemestre = previa.materia.semestre?.nombre || 'N/A';
                
                console.log('‚úÖ Datos extra√≠dos:', {
                    id: materiaId,
                    nombre: materiaNombre,
                    codigo: materiaCodigo,
                    semestre: materiaSemestre,
                    semestreOriginal: previa.materia.semestre
                });
                
                if (!grupos[materiaId]) {
                    grupos[materiaId] = {
                        materia: {
                            _id: materiaId,
                            nombre: materiaNombre,
                            codigo: materiaCodigo,
                            semestre: materiaSemestre
                        },
                        previas: [],
                        totalPrevias: 0,
                        tipos: new Set(),
                        creditosMinimos: 0,
                        activa: true,
                        semestreMinimo: null
                    };
                }
                
                // Agregar previa al grupo
                grupos[materiaId].previas.push({
                    materiaRequerida: previa.materiaRequerida,
                    tipo: previa.tipo,
                    notaMinima: previa.notaMinima,
                    semestreMinimo: previa.semestreMinimo,
                    creditosMinimos: previa.creditosMinimos,
                    activa: previa.activa
                });
                
                // Actualizar contadores y valores
                grupos[materiaId].totalPrevias++;
                grupos[materiaId].tipos.add(previa.tipo);
                grupos[materiaId].creditosMinimos = Math.max(grupos[materiaId].creditosMinimos, previa.creditosMinimos);
                grupos[materiaId].activa = grupos[materiaId].activa && previa.activa;
                grupos[materiaId].semestreMinimo = Math.max(grupos[materiaId].semestreMinimo, previa.semestreMinimo);
            });
            
            console.log('üèóÔ∏è Grupos creados:', grupos);
            
            // Convertir a array y ordenar
            return Object.values(grupos).sort((a, b) => a.materia.codigo.localeCompare(b.materia.codigo));
        }

        function filtrarPrevias() {
            const searchTerm = document.getElementById('search-previas').value.toLowerCase();
            const tipoFilter = document.getElementById('filter-tipo').value;
            const estadoFilter = document.getElementById('filter-estado').value;
            
            previasFiltradas = previas.filter(previa => {
                const matchSearch = !searchTerm || 
                    previa.materia?.nombre?.toLowerCase().includes(searchTerm) ||
                    previa.materia?.codigo?.toLowerCase().includes(searchTerm) ||
                    previa.materiaRequerida?.nombre?.toLowerCase().includes(searchTerm) ||
                    previa.materiaRequerida?.codigo?.toLowerCase().includes(searchTerm);
                
                const matchTipo = !tipoFilter || previa.tipo === tipoFilter;
                const matchEstado = !estadoFilter || previa.activa.toString() === estadoFilter;
                
                return matchSearch && matchTipo && matchEstado;
            });
            
            paginaActual = 1;
            mostrarPrevias();
        }

        function limpiarFiltros() {
            document.getElementById('search-previas').value = '';
            document.getElementById('filter-tipo').value = '';
            document.getElementById('filter-estado').value = '';
            filtrarPrevias();
        }

        function aplicarFiltros() {
            filtrarPrevias();
        }



        function mostrarModalCrearPrevia() {
            document.getElementById('modal-title').textContent = 'Nueva Previa';
            document.getElementById('form-previa').reset();
            document.getElementById('modal-previa').classList.remove('hidden');
        }

        function cerrarModalPrevia() {
            document.getElementById('modal-previa').classList.add('hidden');
        }

        function verPreviasDetalle(materiaId) {
            const modal = document.getElementById('modal-previas-detalle');
            const titulo = document.getElementById('modal-previas-titulo');
            const content = document.getElementById('previas-detalle-content');
            
            // Buscar el bot√≥n correspondiente a esta materia
            const button = document.querySelector(`[data-materia-id="${materiaId}"].btn-ver-previas`);
            
            if (!button) {
                console.error('No se encontr√≥ el bot√≥n para la materia:', materiaId);
                return;
            }
            
            const previasData = button.getAttribute('data-previas');
            const previas = JSON.parse(previasData);
            
            // Buscar la materia para mostrar su nombre
            const materia = materias.find(m => m._id === materiaId);
            
            titulo.textContent = `Previas Requeridas: ${materia ? materia.nombre : 'N/A'}`;
            
            // Generar el contenido HTML para las previas
            content.innerHTML = previas.map(previa => `
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold text-slate-900 mb-2">Materia Requerida</h4>
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 bg-amber-500 rounded-full"></div>
                                <div>
                                    <div class="font-medium text-slate-900">${previa.materiaRequerida?.nombre || 'N/A'}</div>
                                    <div class="text-sm text-slate-500">${previa.materiaRequerida?.codigo || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-slate-900 mb-2">Requisitos</h4>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-slate-600">Tipo:</span>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                        previa.tipo === 'curso_aprobado' 
                                            ? 'bg-emerald-100 text-emerald-800' 
                                            : 'bg-violet-100 text-violet-800'
                                    }">
                                        <i class="fas fa-${previa.tipo === 'curso_aprobado' ? 'graduation-cap' : 'file-alt'} mr-1"></i>
                                        ${previa.tipo === 'curso_aprobado' ? 'Curso Aprobado' : 'Examen Aprobado'}
                                    </span>
                                </div>

                                ${previa.creditosMinimos ? `
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-slate-600">Cr√©ditos M√≠nimos:</span>
                                        <span class="font-medium text-slate-900">${previa.creditosMinimos}</span>
                                    </div>
                                ` : ''}
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-slate-600">Estado:</span>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                        previa.activa 
                                            ? 'bg-emerald-100 text-emerald-800' 
                                            : 'bg-red-100 text-red-800'
                                    }">
                                        <i class="fas fa-${previa.activa ? 'check-circle' : 'times-circle'} mr-1"></i>
                                        ${previa.activa ? 'Activa' : 'Inactiva'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            modal.classList.remove('hidden');
            
            // Agregar evento para cerrar con Escape
            handleEscape = (e) => {
                if (e.key === 'Escape') {
                    cerrarModalPreviasDetalle();
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        function cerrarModalPreviasDetalle() {
            document.getElementById('modal-previas-detalle').classList.add('hidden');
            
            // Limpiar eventos de teclado
            if (handleEscape) {
                document.removeEventListener('keydown', handleEscape);
                handleEscape = null;
            }
        }



        function abrirModalPrevia() {
            document.getElementById('modal-title').textContent = 'Nueva Previa';
            document.getElementById('form-previa').reset();
            document.getElementById('modal-previa').classList.remove('hidden');
        }

        document.getElementById('form-previa').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                materia: formData.get('materia'),
                materiaRequerida: formData.get('materiaRequerida'),
                tipo: formData.get('tipo'),
                notaMinima: parseInt(formData.get('notaMinima')),
                semestreMinimo: formData.get('semestreMinimo') ? parseInt(formData.get('semestreMinimo')) : undefined,
                creditosMinimos: formData.get('creditosMinimos') ? parseInt(formData.get('creditosMinimos')) : undefined,
                activa: formData.get('activa') === 'on'
            };
            
            try {
                const response = await fetch('/admin/api/previas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data),
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status}`);
                }
                
                const nuevaPrevia = await response.json();
                mostrarNotificacion('√âxito', 'Previa creada correctamente');
                cerrarModalPrevia();
                cargarPrevias();
                
            } catch (error) {
                console.error('Error creando previa:', error);
                mostrarError('Error creando previa: ' + error.message);
            }
        });

        async function togglePrevia(id, estadoActual) {
            try {
                const response = await fetch(`/admin/api/previas/${id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ activa: !estadoActual }),
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status}`);
                }
                
                mostrarNotificacion('√âxito', `Previa ${!estadoActual ? 'activada' : 'desactivada'} correctamente`);
                cargarPrevias();
                
            } catch (error) {
                console.error('Error cambiando estado de previa:', error);
                mostrarError('Error cambiando estado: ' + error.message);
            }
        }

        async function eliminarPrevia(id) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta previa?')) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/previas/${id}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status}`);
                }
                
                mostrarNotificacion('√âxito', 'Previa eliminada correctamente');
                cargarPrevias();
                
            } catch (error) {
                console.error('Error eliminando previa:', error);
                mostrarError('Error eliminando previa: ' + error.message);
            }
        }

        function mostrarNotificacion(titulo, mensaje) {
            const notificacion = document.createElement('div');
            notificacion.className = 'fixed top-4 right-4 bg-white border-l-4 border-emerald-500 shadow-lg rounded-lg p-4 z-50 max-w-sm transform transition-all duration-300 ease-in-out';
            notificacion.style.transform = 'translateX(100%)';
            notificacion.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle text-emerald-500"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-slate-900">${titulo}</p>
                        <p class="text-sm text-slate-500">${mensaje}</p>
                    </div>
                    <div class="ml-auto pl-3">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-slate-400 hover:text-slate-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notificacion);
            
            setTimeout(() => {
                notificacion.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                if (notificacion.parentElement) {
                    notificacion.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (notificacion.parentElement) {
                            notificacion.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }

        function mostrarError(mensaje) {
            const notificacion = document.createElement('div');
            notificacion.className = 'fixed top-4 right-4 bg-white border-l-4 border-red-500 shadow-lg rounded-lg p-4 z-50 max-w-sm transform transition-all duration-300 ease-in-out';
            notificacion.style.transform = 'translateX(100%)';
            notificacion.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-red-500"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-slate-900">Error</p>
                        <p class="text-sm text-slate-500">${mensaje}</p>
                    </div>
                    <div class="ml-auto pl-3">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-slate-400 hover:text-slate-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notificacion);
            
            setTimeout(() => {
                notificacion.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                if (notificacion.parentElement) {
                    notificacion.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (notificacion.parentElement) {
                            notificacion.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }
    </script>
</body>
</html> 